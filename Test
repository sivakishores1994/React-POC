import React from "react";
import { render } from "@testing-library/react";
import { Provider } from "react-redux";
import configureStore from "redux-mock-store";
import Header from "./Header";
import { getUrl } from "../../../utils/common/change.utils";

// Mocking dependencies
jest.mock("../../../utils/common/change.utils", () => ({
  getUrl: {
    getParameterByName: jest.fn(),
  },
}));

jest.mock("../../../utils/store/store", () => ({
  store: {
    getState: jest.fn(() => ({
      stages: { isDocumentUpload: false },
    })),
  },
}));

jest.mock("../../../utils/common/header-titles", () =>
  jest.fn(() => "Mocked Header Title")
);

jest.mock("../../../shared/components/close/close", () => () => (
  <div data-testid="close-button">Close Button</div>
));

jest.mock("../../../shared/components/logo/logo", () => () => (
  <div data-testid="logo">Logo</div>
));

const mockStore = configureStore([]);

describe("Header Component", () => {
  let store: any;

  beforeEach(() => {
    store = mockStore({
      stages: {
        stages: [
          {
            stageId: "testStage",
            stageInfo: {
              application: { journey_type: "ETC" },
              products: [
                {
                  name: "Product Name",
                  product_category: "CC",
                  product_type: "280",
                },
              ],
            },
          },
        ],
        journeyType: "ETC",
      },
    });

    (getUrl.getParameterByName as jest.Mock).mockReturnValue(null);
  });

  it("renders without crashing", () => {
    const { getByText } = render(
      <Provider store={store}>
        <Header />
      </Provider>
    );

    expect(getByText("Mocked Header Title")).toBeInTheDocument();
  });

  it("renders product details if available", () => {
    const { getByText } = render(
      <Provider store={store}>
        <Header />
      </Provider>
    );

    expect(getByText("Product Name")).toBeInTheDocument();
  });

  it("does not render product details if 'auth' is 'upload'", () => {
    (getUrl.getParameterByName as jest.Mock).mockReturnValue("upload");

    const { queryByText } = render(
      <Provider store={store}>
        <Header />
      </Provider>
    );

    expect(queryByText("Product Name")).not.toBeInTheDocument();
  });

  it("renders the close button if applicable", () => {
    const { getByTestId } = render(
      <Provider store={store}>
        <Header />
      </Provider>
    );

    expect(getByTestId("close-button")).toBeInTheDocument();
  });

  it("renders the logo in desktop view", () => {
    const { getByTestId } = render(
      <Provider store={store}>
        <Header />
      </Provider>
    );

    expect(getByTestId("logo")).toBeInTheDocument();
  });

  it("renders pending application header and subheader if on '/pending-application' path", () => {
    Object.defineProperty(window, "location", {
      value: {
        pathname: "/pending-application",
      },
      writable: true,
    });

    const { getByText } = render(
      <Provider store={store}>
        <Header />
      </Provider>
    );

    expect(getByText("Resume Your Application")).toBeInTheDocument();
    expect(getByText("You can continue your application from where you left off.")).toBeInTheDocument();
  });

  it("applies wave styles based on header content dimensions", () => {
    const { container } = render(
      <Provider store={store}>
        <Header />
      </Provider>
    );

    const waveSpan = container.querySelector(".header__waves");
    expect(waveSpan).toHaveStyle(`height: 0px`);
    expect(waveSpan).toHaveStyle(`top: 0px`);
  });

  it("cleans up event listeners on unmount", () => {
    const removeEventListenerSpy = jest.spyOn(window, "removeEventListener");

    const { unmount } = render(
      <Provider store={store}>
        <Header />
      </Provider>
    );

    unmount();
    expect(removeEventListenerSpy).toHaveBeenCalledWith("onload", expect.any(Function));
    expect(removeEventListenerSpy).toHaveBeenCalledWith("resize", expect.any(Function));
  });
});
